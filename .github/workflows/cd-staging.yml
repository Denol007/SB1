name: CD - Deploy to Staging

on:
  push:
    branches:
      - develop
  workflow_dispatch:  # Allow manual trigger

env:
  PYTHON_VERSION: "3.12"
  REGISTRY: ghcr.io
  IMAGE_NAME: denol007/sb1  # Must be lowercase for container registry

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=staging-
            type=raw,value=staging-latest

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./studybuddy-backend
          file: ./studybuddy-backend/docker/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache-staging
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache-staging,mode=max
          build-args: |
            ENVIRONMENT=staging

  deploy-to-kubernetes:
    name: Deploy to Staging Kubernetes
    runs-on: ubuntu-latest
    needs: build-and-push
    environment:
      name: staging
      url: https://staging-api.studybuddy.example.com
    defaults:
      run:
        working-directory: studybuddy-backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure kubectl
        uses: azure/k8s-set-context@v4
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG_STAGING }}

      - name: Create namespace if not exists
        run: |
          kubectl create namespace studybuddy-staging --dry-run=client -o yaml | kubectl apply -f -

      - name: Create/update secrets
        run: |
          kubectl create secret generic studybuddy-secrets \
            --from-literal=DATABASE_URL="${{ secrets.STAGING_DATABASE_URL }}" \
            --from-literal=REDIS_URL="${{ secrets.STAGING_REDIS_URL }}" \
            --from-literal=SECRET_KEY="${{ secrets.STAGING_SECRET_KEY }}" \
            --from-literal=JWT_SECRET_KEY="${{ secrets.STAGING_JWT_SECRET_KEY }}" \
            --from-literal=GOOGLE_CLIENT_ID="${{ secrets.STAGING_GOOGLE_CLIENT_ID }}" \
            --from-literal=GOOGLE_CLIENT_SECRET="${{ secrets.STAGING_GOOGLE_CLIENT_SECRET }}" \
            --from-literal=SMTP_PASSWORD="${{ secrets.STAGING_SMTP_PASSWORD }}" \
            --from-literal=SENTRY_DSN="${{ secrets.STAGING_SENTRY_DSN }}" \
            --namespace=studybuddy-staging \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Update image tag in deployment
        run: |
          cd kubernetes
          sed -i "s|IMAGE_TAG|${{ needs.build-and-push.outputs.image-tag }}|g" api-deployment.yaml
          sed -i "s|IMAGE_TAG|${{ needs.build-and-push.outputs.image-tag }}|g" celery-deployment.yaml

      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f kubernetes/namespace.yaml --namespace=studybuddy-staging || true
          kubectl apply -f kubernetes/configmap.yaml --namespace=studybuddy-staging
          kubectl apply -f kubernetes/api-deployment.yaml --namespace=studybuddy-staging
          kubectl apply -f kubernetes/celery-deployment.yaml --namespace=studybuddy-staging
          kubectl apply -f kubernetes/ingress.yaml --namespace=studybuddy-staging
          kubectl apply -f kubernetes/hpa.yaml --namespace=studybuddy-staging

      - name: Wait for rollout to complete
        run: |
          kubectl rollout status deployment/studybuddy-api --namespace=studybuddy-staging --timeout=5m
          kubectl rollout status deployment/studybuddy-celery-worker --namespace=studybuddy-staging --timeout=5m

      - name: Run database migrations
        run: |
          kubectl run migration-job-${{ github.run_number }} \
            --image=${{ needs.build-and-push.outputs.image-tag }} \
            --restart=Never \
            --namespace=studybuddy-staging \
            --env-from=secret/studybuddy-secrets \
            --command -- uv run alembic upgrade head

      - name: Wait for migration to complete
        run: |
          kubectl wait --for=condition=complete --timeout=5m \
            pod/migration-job-${{ github.run_number }} \
            --namespace=studybuddy-staging

      - name: Get deployment status
        run: |
          kubectl get pods --namespace=studybuddy-staging
          kubectl get services --namespace=studybuddy-staging
          kubectl get ingress --namespace=studybuddy-staging

  health-check:
    name: Verify Deployment Health
    runs-on: ubuntu-latest
    needs: deploy-to-kubernetes

    steps:
      - name: Wait for deployment to stabilize
        run: sleep 30

      - name: Check API health endpoint
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://staging-api.studybuddy.example.com/health)
          if [ $response -eq 200 ]; then
            echo "✅ Health check passed!"
          else
            echo "❌ Health check failed with status code: $response"
            exit 1
          fi

      - name: Check readiness endpoint
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://staging-api.studybuddy.example.com/health/ready)
          if [ $response -eq 200 ]; then
            echo "✅ Readiness check passed!"
          else
            echo "❌ Readiness check failed with status code: $response"
            exit 1
          fi

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-to-kubernetes, health-check]
    if: always()

    steps:
      - name: Deployment Success
        if: |
          needs.build-and-push.result == 'success' &&
          needs.deploy-to-kubernetes.result == 'success' &&
          needs.health-check.result == 'success'
        run: |
          echo "✅ Staging deployment successful!"
          echo "Image: ${{ needs.build-and-push.outputs.image-tag }}"
          echo "Digest: ${{ needs.build-and-push.outputs.image-digest }}"

      - name: Deployment Failed
        if: |
          needs.build-and-push.result == 'failure' ||
          needs.deploy-to-kubernetes.result == 'failure' ||
          needs.health-check.result == 'failure'
        run: |
          echo "❌ Staging deployment failed!"
          exit 1
